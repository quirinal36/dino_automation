# Chrome Dino Game Automation - PRD (Product Requirements Document)

## 1. 제품 개요

### 1.1 제품명
Chrome Dino Game Automation

### 1.2 버전
v1.2.0

### 1.3 목적
Chrome 브라우저의 오프라인 공룡 게임(chrome://dino)을 컴퓨터 비전 기술을 활용하여 자동으로 플레이하는 Python 프로그램

### 1.4 대상 사용자
- 게임 자동화에 관심 있는 개발자
- 컴퓨터 비전 학습자
- Python 프로그래밍 학습자

---

## 2. 기능 요구사항

### 2.1 ROI 캘리브레이션 (calibrate.py)

| 기능 ID | 기능명 | 설명 | 우선순위 |
|---------|--------|------|----------|
| CAL-001 | 화면 캡처 | 현재 모니터 전체 화면을 캡처 | P0 |
| CAL-002 | 마우스 드래그 선택 | 마우스 드래그로 ROI 영역 선택 | P0 |
| CAL-003 | 실시간 미리보기 | 선택 중인 영역을 녹색 사각형으로 표시 | P1 |
| CAL-004 | ROI 저장 | 선택된 좌표를 JSON 파일로 저장 | P0 |
| CAL-005 | 화면 재캡처 | 'r' 키로 화면 다시 캡처 | P2 |

**키보드 단축키:**
- `s`: ROI 저장
- `r`: 화면 재캡처
- `q`: 프로그램 종료

### 2.2 게임 자동화 (main.py)

| 기능 ID | 기능명 | 설명 | 우선순위 |
|---------|--------|------|----------|
| MAIN-001 | ROI 설정 로드 | roi_config.json에서 좌표 로드 | P0 |
| MAIN-002 | 장애물 감지 | ROI 영역에서 어두운/밝은 픽셀 비율로 장애물 감지 | P0 |
| MAIN-003 | 자동 점프 | 장애물 감지 시 스페이스바 입력 | P0 |
| MAIN-004 | 디버그 이미지 저장 | 점프 시 ROI 영역 이미지 저장 | P1 |
| MAIN-005 | 동적 속도 조정 | 게임 진행에 따른 반응 시간 자동 조정 | P0 |
| MAIN-006 | 다크 모드 자동 전환 | 라이트/다크 모드 자동 감지 및 대응 | P0 |
| MAIN-007 | 디버그 폴더 초기화 | 프로그램 시작 시 기존 디버그 파일 삭제 | P1 |

---

## 3. 핵심 알고리즘

### 3.1 장애물 감지 알고리즘

```
1. ROI 영역 캡처
2. RGB → 그레이스케일 변환
3. 평균 밝기 및 어두운 픽셀 비율 계산
4. 모드별 감지:
   - 라이트 모드: 어두운 픽셀 비율 > 임계값 → 장애물
   - 다크 모드: 밝은 픽셀 비율 > 임계값 → 장애물
5. 장애물 감지 시 점프 실행
```

### 3.2 동적 속도 조정 (SpeedController)

게임 속도는 시간에 따라 증가하므로, 시간 기반으로 파라미터를 동적 조정:

| 파라미터 | 시작 (0초) | 최대 (180초) | 계산 방식 |
|----------|-----------|-------------|-----------|
| 속도 배율 | 1.00x | 2.17x | 로그 곡선 |
| 체크 간격 | 50ms | 23ms | base / speed_factor |
| 점프 쿨다운 | 300ms | 138ms | base / speed_factor |
| 감지 임계값 | 5% | 3% | 선형 감소 |

**속도 배율 공식:**
```python
speed_factor = 1.0 + 1.17 * (log(1 + 2 * progress) / log(3))
```

### 3.3 다크 모드 감지

| 조건 | 동작 |
|------|------|
| 어두운 픽셀 비율 ≥ 95% | 다크 모드로 전환 |
| 어두운 픽셀 비율 ≤ 5% | 라이트 모드로 전환 |

---

## 4. 시스템 아키텍처

### 4.1 클래스 구조

```
┌─────────────────────────────────────────────────────────────┐
│                      main.py                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────┐    ┌─────────────────────────────┐│
│  │   SpeedController   │    │       DinoGameBot           ││
│  ├─────────────────────┤    ├─────────────────────────────┤│
│  │ - start_time        │    │ - roi                       ││
│  │ - MAX_SPEED_FACTOR  │    │ - running                   ││
│  │ - TIME_TO_MAX       │    │ - jump_count                ││
│  │ - BASE_CHECK_INTERVAL│   │ - dark_mode                 ││
│  │ - BASE_JUMP_COOLDOWN │   │ - speed_controller          ││
│  ├─────────────────────┤    ├─────────────────────────────┤│
│  │ + start()           │    │ + load_roi_config()         ││
│  │ + get_speed_factor()│    │ + capture_roi()             ││
│  │ + get_check_interval│    │ + check_dark_mode()         ││
│  │ + get_jump_cooldown │    │ + is_obstacle_detected()    ││
│  │ + get_dark_ratio_   │    │ + save_debug_image()        ││
│  │   threshold()       │    │ + jump()                    ││
│  └─────────────────────┘    │ + run()                     ││
│                             └─────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    calibrate.py                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐│
│  │                   ROICalibrator                         ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ - roi_coords, start_point, end_point                    ││
│  │ - drawing, screenshot, display_img                      ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ + mouse_callback()                                      ││
│  │ + capture_screen()                                      ││
│  │ + draw_rectangle()                                      ││
│  │ + save_roi()                                            ││
│  │ + run()                                                 ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 4.2 데이터 흐름

```
[화면 캡처] → [ROI 추출] → [그레이스케일 변환] → [밝기 분석]
                                                    ↓
                                            [모드 감지]
                                                    ↓
[스페이스바 입력] ← [점프 판단] ← [장애물 감지] ← [픽셀 비율 계산]
       ↓
[디버그 이미지 저장]
```

---

## 5. 파일 구조

```
dino_automation/
├── .gitignore              # Git 제외 파일 설정
├── LICENSE                 # MIT 라이센스
├── README.md               # 프로젝트 문서
├── PRD.md                  # 제품 요구사항 문서 (현재 파일)
├── PUBLISH_GUIDE.md        # GitHub publish 가이드
├── prompt.md               # 프롬프트 히스토리
├── requirements.txt        # Python 패키지 의존성
├── calibrate.py            # ROI 캘리브레이션 도구
├── main.py                 # 게임 자동화 메인 프로그램
├── roi_config.json         # ROI 설정 파일 (사용자 생성)
└── debug_captures/         # 디버그 이미지 저장 폴더 (자동 생성)
    └── jump_XXXX_timestamp.png
```

---

## 6. 기술 스택

| 분류 | 기술 | 용도 |
|------|------|------|
| 언어 | Python 3.7+ | 메인 개발 언어 |
| 컴퓨터 비전 | OpenCV (cv2) | 이미지 처리 및 분석 |
| 화면 캡처 | PIL (ImageGrab) | 스크린샷 캡처 |
| 키보드 입력 | PyAutoGUI | 자동 키 입력 |
| 데이터 처리 | NumPy | 배열 연산 |
| 설정 저장 | JSON | ROI 좌표 저장 |

---

## 7. 설치 및 실행

### 7.1 설치
```bash
pip install -r requirements.txt
```

### 7.2 실행 순서
```bash
# 1단계: ROI 캘리브레이션
python calibrate.py

# 2단계: 게임 자동화 실행
python main.py
```

---

## 8. 콘솔 출력 예시

### 8.1 시작 시
```
Chrome Dino Game Bot을 시작합니다...

디버그 폴더 초기화: debug_captures
ROI 설정 로드 완료:
  좌표: (343, 252) ~ (415, 288)
  크기: 72 x 46

============================================================
Chrome Dino Game Automation 시작
============================================================
동적 속도 조정: 활성화
  - 초기 체크 간격: 50ms
  - 초기 쿨다운: 300ms
  - 최대 속도 배율: 2.17x (약 180초 후)
디버그 이미지 저장 위치: debug_captures/
```

### 8.2 게임 중
```
점프! (총 1번)
  - 평균 밝기: 245.3, 어두운 픽셀 비율: 8.2%
  - 디버그 이미지 저장: debug_captures/jump_0001_20260110_120000_123.png

[속도] 30초 | 1.35x | 모드: 라이트 | 체크: 37ms | 쿨다운: 222ms | 임계값: 4.4%

[모드 전환] 다크 모드 감지 → 밝은 픽셀 감지로 전환

점프! (총 15번)
  - 평균 밝기: 45.2, 밝은 픽셀 비율: 7.5%
```

### 8.3 종료 시
```
사용자에 의해 중단되었습니다.
총 플레이 시간: 125.3초
총 점프 횟수: 48번
디버그 이미지: 48개 저장됨
```

---

## 9. 버전 히스토리

| 버전 | 날짜 | 변경 사항 |
|------|------|-----------|
| v1.0.0 | 2026-01-09 | 초기 버전 (ROI 캘리브레이션, 기본 자동화) |
| v1.1.0 | 2026-01-10 | 동적 속도 조정 (SpeedController) 추가 |
| v1.2.0 | 2026-01-10 | 다크 모드 자동 전환, 디버그 폴더 초기화 추가 |

---

## 10. 향후 개선 계획

| 우선순위 | 기능 | 설명 |
|----------|------|------|
| P1 | 새(bird) 장애물 대응 | 높이별 다중 ROI 설정으로 새 장애물 감지 |
| P1 | 웅크리기(duck) 기능 | 아래 화살표 키로 새 장애물 회피 |
| P2 | 머신러닝 도입 | 장애물 패턴 학습으로 예측 정확도 향상 |
| P2 | 점수 인식 | OCR로 실시간 점수 추적 |
| P3 | GUI 인터페이스 | 설정 및 상태 확인용 GUI 추가 |
| P3 | 다중 해상도 대응 | 자동 해상도 감지 및 ROI 조정 |

---

## 11. 참고 자료

- **GitHub 저장소**: https://github.com/quirinal36/dino_automation
- **Chrome Dino Game**: chrome://dino
- **개발 프롬프트 히스토리**: [prompt.md](prompt.md)
